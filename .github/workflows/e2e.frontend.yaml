name: e2e:frontend
on:
  pull_request:
    # paths:
    #   - 'frontend/**'
jobs:
  e2e:
    runs-on: ubuntu-latest
    services:
      db:
        image: postgres
        env:
          POSTGRES_USER: unleash_user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: unleash_test
          POSTGRES_INITDB_ARGS: "--no-sync"
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      unleashEnterprise:
        image: 726824350591.dkr.ecr.eu-central-1.amazonaws.com/unleash-enterprise:latest
        credentials:
          username: AWS
          password: ${{ secrets.ECR_ENTERPRISE_TOKEN }}
        env:
          DATABASE_URL: "postgres://postgres:unleash@localhost/unleash"
          UNLEASH_LICENSE: ${{ secrets.FRONTEND_TEST_LICENSE }}


    strategy:
      matrix:
        test:
          - feature/feature.spec.ts
          - groups/groups.spec.ts
          - projects/access.spec.ts
          - segments/segments.spec.ts
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          echo "$GITHUB_CONTEXT"
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run Cypress
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          env: AUTH_USER=admin,AUTH_PASSWORD=unleash4all
          config: baseUrl=${{ github.event.deployment_status.target_url }}
          spec: cypress/integration/${{ matrix.test }}
          install-command: yarn --immutable
