name: e2e:frontend
on:
  pull_request:
    # paths:
    #   - 'frontend/**'
jobs:
  get-token:
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.get-token.outputs.token }}
    steps:
      - uses: actions/checkout@v2
      - name: Get Token
        id: get-token
        run: |
          echo "token=$(curl https://app.unleash-hosted.com/docker-login/token/${{ secrets.ECR_ENTERPRISE_TOKEN }})" >> $GITHUB_OUTPUT

  e2e:
    runs-on: ubuntu-latest
    needs: get-token
    services:
      db:
        image: postgres
        env:
          POSTGRES_USER: unleash_user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: unleash_test
          POSTGRES_INITDB_ARGS: "--no-sync"
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      unleashEnterprise:
        image: 726824350591.dkr.ecr.eu-central-1.amazonaws.com/unleash-enterprise:latest
        credentials:
          username: AWS
          password: ${{ needs.get-token.outputs.token }}
        env:
          DATABASE_URL: "postgres://postgres:unleash@localhost/unleash"
          UNLEASH_LICENSE: ${{ secrets.FRONTEND_TEST_LICENSE }}
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:4242/health || exit 1" 
          --health-interval 10s 
          --health-timeout 5s 
          --health-retries 5


    strategy:
      matrix:
        test:
          - feature/feature.spec.ts
          - groups/groups.spec.ts
          - projects/access.spec.ts
          - segments/segments.spec.ts
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          echo "$GITHUB_CONTEXT"
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run Cypress
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          env: AUTH_USER=admin,AUTH_PASSWORD=unleash4all
          config: baseUrl=http://localhost:4242
          spec: cypress/integration/${{ matrix.test }}
          install-command: yarn --immutable
