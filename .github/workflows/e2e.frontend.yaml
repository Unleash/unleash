name: e2e:frontend
on:
  pull_request:
    # paths:
    #   - 'frontend/**'
jobs:
  get-token:
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.get-token.outputs.token }}
    steps:
      - uses: actions/checkout@v2
      - name: Get Token
        id: get-token
        run: |
          echo "token=$(curl https://app.unleash-hosted.com/docker-login/token/${{ secrets.ECR_ENTERPRISE_TOKEN }})" >> $GITHUB_OUTPUT

  e2e:
    runs-on: ubuntu-latest
    needs: get-token
    strategy:
      matrix:
        test:
          - feature/feature.spec.ts
          - groups/groups.spec.ts
          - projects/access.spec.ts
          - segments/segments.spec.ts
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          echo "$GITHUB_CONTEXT"
      - name: Checkout
        uses: actions/checkout@v4
      - name: Start Unleash test instance
        run: |
          echo ${{ needs.get-token.outputs.token }} | docker login --username AWS --password-stdin 726824350591.dkr.ecr.eu-central-1.amazonaws.com
          docker compose up -f .github/docker-compose.test.yml -d --wait -t 90
        env:
          FRONTEND_TEST_LICENSE: ${{ secrets.FRONTEND_TEST_LICENSE }}
      - name: Run Cypress
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          env: AUTH_USER=admin,AUTH_PASSWORD=unleash4all
          config: baseUrl=http://localhost:4242
          spec: cypress/integration/${{ matrix.test }}
          install-command: yarn --immutable
