name: Test db migrations

on:
  pull_request:
    branches:
      - main
    paths:
      - 'src/migrations/**'
      - '.github/workflows/validate-migrations.yaml'
      - 'test-migrations/**'
  workflow_dispatch:

jobs:
  test-migrations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Start Unleash test instance
        working-directory: test-migrations
        run: docker compose up -d --wait -t 90
      - name: Run Cypress
        uses: cypress-io/github-action@v5
        with:
          working-directory: frontend
          env: AUTH_USER=admin,AUTH_PASSWORD=unleash4all
          config: baseUrl=http://localhost:4242
          # only OSS specs
          spec: cypress/integration/feature/feature.spec.ts,cypress/integration/projects/access.spec.ts,cypress/integration/segments/segments.spec.ts,cypress/integration/import/import.spec.ts
      