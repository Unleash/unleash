# Continue from components/schemas/200seenapps (schema needs work and isn't displaying in Swagger UI).
# Run tests against prevous items (I've done a global strategies $ref replacement)
# Add examples to everything (inclusing response schemas)
# Verify response schemas match object structure
# Check question marks with unleash team
# $ref any duplicate aspects
# British English or American English?
# {} in a definition means 'I don't know' - fix
# Need a variants schema
openapi: 3.0.0
servers:
  - description: Local host.
    url: 'http://localhost:4242/api'
tags:
  - name: Archive
    description: Handling Feature Toggle archiving and un-archiving
  - name: Feature toggles
    description: Accessing feature toggles
  - name: Metrics
    description: Determining usage of feature toggles and applications
  - name: Strategies
    description: Accessing and updating strategies
info:
  title: Unleash API
  description: Unleash is a open source feature flag and toggle system for all your applications and services.
  version: 3.5.6
  contact:
    name: The Unleash team
    url: 'https://unleash.github.io/'
    email: some_email@gmail.com
externalDocs:
  description: Unleash documentation
  url: 'https://unleash.github.io/docs/getting_started'
paths:
  /admin/features:
    get:
      summary: Fetches all feature toggles from the Unleash server.
      description: |
        The response returns all active feature toggles and their current strategy configuration:
        - A feature toggle will have *at least* one configured strategy.
        - A strategy will have a `name` and `parameters` map.

        **Note:** To only return one Feature Toggle, add the Feature Toggle name as a suffix to the request. For example: `GET [Your host]/api/admin/features/featureX`. It is not possible to add this parameter as a *Try it out* option due to restrictions in the [Open API Specification](https://swagger.io/docs/specification/describing-parameters/), (that is, *optional* path variables cannot be created).
      externalDocs:
        description: Activation strategies
        url: 'https://unleash.github.io/docs/activation_strategy'
      operationId: getFeatures
      tags:
        - Feature toggles
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200'
        '401':
          description: Not authorised
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/401'
    post:
      description: Create a new Feature Toggle
      tags:
        - Feature toggles
      operationId: createFeatureToggle
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/newFeatureToggle'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200'
        '409':
          description: Feature Toggle name is not unique
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/409'
      summary: Create a Feature Toggle
  '/admin/features/{featureName}':
    put:
      summary: Update a Feature Toggle
      description: Update a Feature Toggle.
      operationId: featureName
      tags:
        - Feature toggles
      parameters:
        - $ref: '#/components/parameters/featureNamePath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/updateFeatureToggle'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200'
    delete:
      summary: Archive a Feature Toggle.
      description: |
        Feature toggles can only be archived - they cannot be deleted.

        If an old Feature Toggle *re-appears*, this is because someone else has created a new one with the same name.
      operationId: archiveFeatureToggle
      tags:
        - Feature toggles
      parameters:
        - $ref: '#/components/parameters/featureNamePath'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200'
  '/admin/features/{featureName}/toggle/on':
    post:
      summary: Enable a Feature Toggle.
      description: '*featureName* must match an existing Feature Toggle.'
      operationId: enableFeatureToggle
      tags:
        - Feature toggles
      parameters:
        - $ref: '#/components/parameters/featureNamePath'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200'
  '/admin/features/{featureName}/toggle/off':
    post:
      summary: Disable a Feature Toggle.
      description: '*featureName* must match an existing Feature Toggle.'
      operationId: disableFeatureToggle
      tags:
        - Feature toggles
      parameters:
        - $ref: '#/components/parameters/featureNamePath'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200'
  '/admin/features/{featureName}/stale/on':
    post:
      summary: Mark a Feature Toggle as 'stale' (deprecated).
      description: '*featureName* must match an existing Feature Toggle.'
      externalDocs:
        description: Feature Toggle types
        url: 'https://unleash.github.io/docs/feature_toggle_types'
      operationId: markFeatureToggleStale
      tags:
        - Feature toggles
      parameters:
        - $ref: '#/components/parameters/featureNamePath'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200'
  '/admin/features/{featureName}/stale/off':
    post:
      summary: Mark a Feature Toggle as active.
      description: '*featureName* must match an existing Feature Toggle.'
      externalDocs:
        description: Feature Toggle types
        url: 'https://unleash.github.io/docs/feature_toggle_types'
      operationId: markFeatureToggleActive
      tags:
        - Feature toggles
      parameters:
        - $ref: '#/components/parameters/featureNamePath'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200'
        '409':
          description: Feature Toggle name is not unique.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/409'
  /admin/archive/features:
    get:
      summary: List all the archived feature toggles on the Unleash server
      description: Archived feature toggles are those that have been previously deleted
      operationId: fetchArchivedToggles
      tags:
        - Archive
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200'
  '/admin/archive/revive/{featureName}':
    post:
      summary: Un-archive a Feature Toggle
      description: The Feature Toggle had been previously deleted
      operationId: reviveFeatureToggle
      tags:
        - Archive
      parameters:
        - $ref: '#/components/parameters/featureNamePath'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200'
  /admin/strategies:
    get:
      summary: Fetch all strategies and their parameters.
      description: Fetch all strategies and their parameters.
      operationId: getStrategies
      tags:
        - Strategies
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200strategy'
    post:
      summary: Create Strategy
      description: Create Strategy
      operationId: createStrategy
      tags:
        - Strategies
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/createStrategy'
      responses:
        '201':
          description: Strategy successfully added
  '/admin/strategies/{strategyName}':
    put:
      summary: Update Strategy
      description: |
        Use to update a Strategy definition.

        *name* and *strategyName* must match and must also match an existing Strategy name.

        **Caution:** It can be dangerous to change a Strategy (as the implementation also might need to be changed).
      operationId: updateStrategy
      tags:
        - Strategies
      parameters:
        - $ref: '#/components/parameters/strategyNamePath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/createStrategy'
      responses:
        '200':
          description: Strategy successfully updated.
  /admin/metrics/seen-toggles:
    get:
      summary: Returns a list of applications and the feature toggles that Unleash has 'seen' for each application.
      description: 'It is only guaranteed that feature toggles reported by client applications within the last hour will be returned. However, in most cases, earlier reported feature toggles will also be returned.'
      operationId: seenToggles
      tags:
        - Metrics
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200seen'
  /admin/metrics/feature-toggles:
    get:
      summary: 'Gives ''last minute'' and ''last hour'' metrics for all active toggles (based on what was reported by the client applications).'
      description: |
        - **Yes** is the number of times a given feature toggle was enabled in a client applcation
        - **No** is the number of times it was disabled.
      operationId: featureToggles
      tags:
        - Metrics
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200feature'
  /admin/metrics/applications:
    get:
      summary: A list of known applications ('seen' by Unleash in the last two days)
      description: Also has a link for more details.
      operationId: getApplications
      tags:
        - Metrics
      parameters:
        - $ref: '#/components/parameters/strategyQuery'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200application'
  '/admin/metrics/applications/{appName}':
    get:
      summary: Details about a client application.
      description: 'Details include things such as instances, strategies implemented and seen feature toggles.'
      operationId: getApplicationDetails
      tags:
        - Metrics
      parameters:
        - $ref: '#/components/parameters/appNamePath'

      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200appdetails'
  '/admin/metrics/seen-apps':
    get:
      summary: Details about application seen per Feature Toggle.
      description: Details about application seen per Feature Toggle.
      operationId: seenApps
      tags:
        - Metrics
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/200seenapps'
components:
  parameters:
    strategyQuery:
      name: strategyName
      in: query
      description: '(Optional). Return all applications implementing the specified Strategy. Must match an existing Strategy name.'
      schema:
        type: string
    featureNamePath:
      name: featureName
      required: true
      in: path
      description: Must match an existing Feature Toggle.
      schema:
        type: string
    strategyNamePath:
      name: strategyName
      required: true
      in: path
      description: Must match an existing Strategy name.
      schema:
        type: string
    appNamePath:
      name: appName
      required: true
      in: path
      description: Must match an existing application name.
      schema:
        type: string
  schemas:
    '200':
      title: Successful response
      type: object
      properties:
        version:
          type: number
        features:
          type: array
          uniqueItems: true
          minItems: 1
          items:
            properties:
              name:
                type: string
                minLength: 1
              description:
                type: string
                minLength: 1
              type:
                type: string
                minLength: 1
              enabled:
                type: boolean
              stale:
                type: boolean
              strategies:
                $ref: '#/components/schemas/strategySchema'
              variants:
                type: array
                uniqueItems: true
                minItems: 1
                items:
                  required:
                    - name
                    - weight
                  properties:
                    name:
                      type: string
                      minLength: 1
                    weight:
                      type: number
    '401':
      description: Not authorised
      type: object
      properties:
        type:
          type: string
          minLength: 1
        path:
          type: string
          minLength: 1
        message:
          type: string
          minLength: 1
      required:
        - type
        - path
        - message
    '409':
      type: object
      properties:
        isJoi:
          type: boolean
        name:
          type: string
          minLength: 1
        details:
          type: array
          uniqueItems: true
          minItems: 1
          items:
            required:
              - message
            properties:
              message:
                type: string
                minLength: 1
      required:
        - isJoi
        - name
        - details
    200strategy:
      description: Successful.
      type: object
      required:
        - version
        - strategies
      properties:
        version:
          type: number
          example: 1
        strategies:
          $ref: '#/components/schemas/strategySchema'

    newFeatureToggle:
      type: object
      required:
        - name
        - description
        - enabled
        - stale
        - strategies
      properties:
        name:
          type: string
          minLength: 1
          description: Feature Toggle name must be unique.
          example: FeatureA
        description:
          type: string
          minLength: 1
          example: Toggles FeatureA on and off
        type:
          type: string
          enum:
            - release
            - experiment
            - ops
            - killswitch
            - permission
          minLength: 1
          description: '*type* is optional. If not defined, it defaults to `release`'
          externalDocs:
            description: Feature Toggle types
            url: 'https://unleash.github.io/docs/feature_toggle_types'
          example: release
        enabled:
          type: boolean
          example: false
        stale:
          description: Is the Feature Toggle deprecated (stale)?
          type: boolean
          example: false
        strategies:
          $ref: '#/components/schemas/strategySchema'

    updateFeatureToggle:
      type: object
      properties:
        description:
          type: string
          minLength: 1
          example: Toggles FeatureB on and off
        type:
          type: string
          minLength: 1
          description: '*type* is optional. If not defined, it defaults to `release`'
          example: release
        enabled:
          type: boolean
          example: false
        stale:
          type: boolean
          example: false
        strategies:
          $ref: '#/components/schemas/strategySchema'
        variants: {}
        createdAt:
          type: string
          minLength: 1
      required:
        - name
        - description
        - enabled
        - stale
        - strategies
        - variants

    createStrategy:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          example: gradualRollout
        description:
          type: string
          minLength: 1
          example: Gradual rollout to logged in users
        parameters:
          type: array
          uniqueItems: true
          minItems: 1
          items:
            required:
              - name
              - type
              - description
              - required
            properties:
              name:
                type: string
                minLength: 1
                example: percentage
              type:
                type: string
                minLength: 1
                example: percentage
              description:
                type: string
                minLength: 1
                example: How many percent of users should the new Feature Toggle be active for.
              required:
                type: boolean
      required:
        - name
        - description
        - parameters
    200seen:
      type: array
      description: ''
      minItems: 1
      uniqueItems: true
      items:
        type: object
        required:
          - appName
          - seenToggles
          - metricsCount
        properties:
          appName:
            type: string
            minLength: 1
          seenToggles:
            type: array
            items:
              properties: {}
          metricsCount:
            type: number
    200feature:
      description: |
        - **lastHour** - how many times a Feature Toggle was accessed in the last hour.
        - **lastMinute** - how many times a Feature Toggle was accessed in the last minute.
      type: array
      minItems: 1
      uniqueItems: true
      items:
        type: object
        required:
          - appName
          - seenToggles
        properties:
          appName:
            type: string
            enum: [lastHour, lastMinute]
            minLength: 1
            example: lastHour
          seenToggles:
            type: object
            required:
            - yesno
            - metricsCount
            properties:
              yesno:
                type: string
                enum: [yes, no]
              metricsCount:
                type: number
    200application:
      type: object
      properties:
        applications:
          type: array
          uniqueItems: true
          minItems: 1
          items:
            required:
              - appName
              - createdAt
              - updatedAt
            properties:
              appName:
                description: Application name
                type: string
                minLength: 1
                example: my-application
              createdAt:
                description: Date and time when the application was initially created
                type: string
                minLength: 1
                example: '2016-12-09T14:56:36.730Z'
              updatedAt:
                description: Date and time when the application was last updated
                type: string
                minLength: 1
                example: '2020-11-14T09:55:23.653Z'
              description:
                description: A description of what the application does
                type: string
              strategies:
                description: The Strategy's name
                type: array
                minLength: 1
              url:
                description: Link to more information about the application? Relative only?
                type: string
                example: https://medium.com/keptn
              color:
                description: The colour (American English?) of something. Hex code?
                type: string
              icon:
                description: The icon to use for something. Link?
                type: string
      required:
        - applications

    200appdetails:
      type: object
      required:
        - appName
        - instances
        - strategies
        - seenToggles
      properties:
        appName:
          description: Application name
          type: string
          minLength: 1
          example: my-application
        createdAt:
          description: Date and time when the application was initially created
          type: string
          minLength: 1
          example: '2016-12-09T14:56:36.730Z'
        description:
          description: A description of what the application does
          type: string
        url:
          description: Link to more information about the application? Relative only?
          type: string
          example: https://medium.com/keptn
        color:
          description: The colour (American English?) of something. Hex code?
          type: string
        icon:
          description: The icon to use for something. Link?
          type: string
        strategies:
          $ref: '#/components/schemas/strategySchema'

        instances:
          type: object
          required:
            - appName
            - instanceId
            - sdkVersion
            - clientIp
            - lastSeen
            - createdAt
          properties:
            appName:
              description: Application name
              type: string
              minLength: 1
              example: my-application
            instanceId:
              description: The name of the system running the application
              type: string
              minLength: 1
              example: generated-732038-17080
            sdkVersion:
              description: The version of the Unleash client SDK running the application
              type: string
              minLength: 1
              example: unleash-client-node:3.4.0
            clientIp:
              description: The IP address of the system running this instance of the application. What is the prefix on the string?
              type: string
              minLength: 1
              example: ::ffff:127.0.0.1
            lastSeen:
              description: The last time the application accessed Unleash?
              type: string
              minLength: 1
              example: '2020-11-14T11:17:24.482Z'
            createdAt:
              description: When the application was created?
              type: string
              minLength: 1
              example: '2020-11-13T16:56:29.279Z'
        seenToggles:
          type: array
          uniqueItems: true
          minItems: 1
          items:
            required:
              - name
              - type
              - enabled
              - stale
              - createdAt
            properties:
              name:
                description: Name of the Feature Toggle
                type: string
                minLength: 1
                example: FeatureX
              description:
                description: What the Feature Toggle does
                type: string
              type:
                description: One of the five types of Feature Toggle
                type: string
                externalDocs:
                  description: Feature Toggle types
                  url: 'https://unleash.github.io/docs/feature_toggle_types'
                minLength: 1
                example: release
              enabled:
                description: Is the Feature Toggle enabled?
                type: boolean
              stale:
                description: Is the Feature Toggle 
                type: boolean
              strategies:
                $ref: '#/components/schemas/strategySchema'
              variants:
                description: What is this?
                type: string
              createdAt:
                description: Date and time when the application was initially created
                type: string
                minLength: 1
                example: '2020-11-09T15:25:59.517Z'
        links:
          type: object
          properties:
            self:
              description: What is this?
              type: string
              minLength: 1
          required:
            - self

    '200seenapps':
      type: object
      properties:
        my-toggle:
          type: array
          items:
            required:
              - appName
              - createdAt
              - updatedAt
              - description
              - url
              - icon
            properties:
              appName:
                description: Appplication name
                type: string
                minLength: 1
                example: my-application
              createdAt:
                description: Date and time when the application was initially created
                type: string
                minLength: 1
                example: '2016-12-09T14:56:36.730Z'
              updatedAt:
                description: Date and time when the application was last updated
                type: string
                minLength: 1
                example: '2020-11-14T09:55:23.653Z'
              description:
                description: A description of what the application does
                type: string
                minLength: 1
              strategies:
                $ref: '#/components/schemas/strategySchema'
              url:
                description: Link to more information about the application? Relative only?
                type: string
                minLength: 1
                example: https://medium.com/keptn
              color: {}
              icon:
                type: string
                minLength: 1


    strategySchema:
      type: array
      properties:
        name:
          description: Name of the Strategy
          type: string
          minLength: 1
          example: default
        editable:
          type: boolean
        description:
          description: What the Strategy is
          type: string
          example: Default on/off strategy.
        parameters:
          type: array
          items:
            required:
              - parameter
            properties:
              parameter:
                type: object
                required:
                  - name
                  - type
                properties:
                  name:
                    description: The name of the parameter
                    type: string
                    example: groupId
                  type:
                    description: The type of the parameter
                    type: string
                    example: string
                  description:
                    description: What the parameter does
                    type: string
                    example: Define activation groups to allow you to correlate across feature toggles.
                  required:
                    description: Is this a required parameter?
                    type: boolean